.. _ed_overview:

Overview
********

.. _ed_glossary:

Glossary
------------

**Edge**
  The boundary between the image background and a slit.
 
**Slit** 
  Is the image area (mostly rectangular) with higher flux than the background and limited by two edges.

**Cut**
  Is the rectangular area enclosing one spectrum. The class Cut defines the members and to extract one spectrum from the input image and generate a FITS extension in the output AstroData object

.. _ed_works

How to locate slit edges
------------------------

The main goal when locating edges is to find a list of (x,y) pixel coordinates belonging to one edge along the slit boundary. These are the basic steps to achieve this.

1) Quality of the input image.

 - The GMOS, GNIRS and F2 Flat images should be the results of combining several individual exposures to reduce noise and improve signal to noise.

 - The slits separation is crucial to determine a well defining edge showing no breakage along the dispersion axis. If two slit are as close as one pixel, chances are that the algorithm will fail to find the edge.

2) Prefiltering the input data is necessary in some cases to eliminate the background noise which produces to many unwanted short streak after the Sobel operator.

 - For F2 data, a modified Canny algorithm is used to find edges. The prefiltering is a one sigma standard deviation of the Gauss filter.
 - For GNIRS data, the brightest slits (:ref:`see picture <in_data>`) are clipped to normalized the orders.
 - GMOS, slits are well iluminated and uniform with no need of filtering.

3) Use the Sobel operator from the ndimage package. It return the maximum gradient at positions where there is a change in intensity, such as boundaries between background and a slit. The picture below shows one row section of about 3 slits of a GMOS data file with the positive peak (entering the slit) and a negative peak (exiting the slit) corresponding to the Sobel operator output.

.. image:: _images/gmossobel2.png 

4) Create a binary image by putting the value one on all those points in the Sobel image that are greater than the standard deviation and zero if they are below. The sigma is calculated from the Sobel image. Notice that we are breaking the problem of finding the edges in two. One for positive peaks in the Sobel output image; i.e. the edges when entering the Slit and the negative peaks or the peaks obtained when exiting the slit. This method makes it easy to follow one edge in a crowded environment when we have two close slits separated by no more than 2 pixels for example.

5) Use the *label* function from the ndimage package to label each continue piece of edge. Different pieces have different labels.

6) Then we connect the labels one after another if their coordinates (x,y) fall in a continous edge.

7) Now we use the slit position and the slit width in the MDF table to compare with the (x,y) list found. Using the slit width we find the two slits edges.

8) With the (x,y) lists for each edge we fit a 2nd order polynomial use later in the process to cut a rectangle containing a slit.

